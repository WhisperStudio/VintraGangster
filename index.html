<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vintra Studios - Chat</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: pink;
    }

    #chat-widget-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 9999;
    }

    #chat-bubble {
      background: white;
      color: black;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      animation: pulse 2.5s infinite;
      position: relative;
    }

    #chat-bubble svg {
      pointer-events: none;
    }

    @keyframes pulse {
      0%   { box-shadow: 0 0 0 0 rgba(255,255,255,0.4); }
      70%  { box-shadow: 0 0 0 15px rgba(255,255,255,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
    }

    #chat-window {
      position: absolute;
      bottom: 4.5rem;
      right: 0;
      width: 360px;
      height: 520px;
      background-color: #0a0a0a;
      border: 1px solid #27272a;
      border-radius: 0.75rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      display: none;
      flex-direction: column;
    }

    #chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    #chat-messages::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 10px;
      margin-left: 10px;
    }

    .typing-indicator span {
      display: block;
      width: 8px;
      height: 8px;
      background-color: #ccc;
      border-radius: 50%;
      animation: blink 1.4s infinite ease-in-out both;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { transform: scale(0); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    .curved-text {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .curved-text svg {
      width: 180px;
      height: 60px;
    }

    .curved-text text {
      fill: white;
      font-size: 18px;
      font-weight: 700;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
    }

    .hidden-label {
      opacity: 0;
    }
  </style>
</head>

<body>
  <div id="chat-widget-container">
    <div id="chat-window">
      <div class="p-4 bg-black/30 border-b border-gray-800 flex items-center space-x-3">
        <h3 class="font-semibold text-white">Vintra Support AI</h3>
      </div>
      <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto text-white text-sm"></div>
      <div class="p-3 bg-black/20 border-t border-gray-800">
        <form id="chat-form" class="flex gap-2">
          <input id="chat-input" type="text" placeholder="Skriv en melding..." class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 placeholder-gray-500 text-white focus:outline-none" autocomplete="off" />
          <button type="submit" class="bg-white text-black p-2 rounded-lg hover:bg-gray-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
            </svg>
          </button>
        </form>
      </div>
    </div>

    <div id="chat-bubble">
      <div id="chat-label" class="curved-text">
        <svg viewBox="0 0 200 100">
          <defs>
            <path id="arcPath" d="M 40 50 A 60 60 0 0 1 160 50" fill="none" />
          </defs>
          <text>
            <textPath href="#arcPath" startOffset="50%" text-anchor="middle">
              Chat with us! ðŸ‘‹
            </textPath>
          </text>
        </svg>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72A9.99 9.99 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
    </div>
  </div>

  <script>
    // Generate or retrieve a persistent userId
    let userId = localStorage.getItem("chatUserId");
    if (!userId) {
      userId = crypto.randomUUID();
      localStorage.setItem("chatUserId", userId);
    }

    const chatBubble   = document.getElementById("chat-bubble");
    const chatWindow   = document.getElementById("chat-window");
    const chatForm     = document.getElementById("chat-form");
    const chatInput    = document.getElementById("chat-input");
    const chatMessages = document.getElementById("chat-messages");
    const chatLabel    = document.getElementById("chat-label");

    let hasWelcomed = false;

    chatBubble.addEventListener("click", () => {
      const isVisible = chatWindow.style.display === "flex";
      chatWindow.style.display = isVisible ? "none" : "flex";
      chatLabel.classList.toggle("hidden-label", !isVisible);

      if (!hasWelcomed && !isVisible) {
        hasWelcomed = true;
        addMessage("Hei! Jeg er Vintra sin AI-assistent. Hva kan jeg hjelpe deg med?", "bot");
      }
    });

    chatForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = chatInput.value.trim();
      if (!msg) return;

      addMessage(msg, "user");
      chatInput.value = "";
      scrollToBottom();

      // Show typing indicator
      const typingEl = document.createElement("div");
      typingEl.className = "typing-indicator";
      typingEl.id = "typing";
      typingEl.innerHTML = `<span></span><span></span><span></span>`;
      chatMessages.appendChild(typingEl);
      scrollToBottom();

      try {
        // Send to your Next.js API endpoint
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId, message: msg }),
        });
        const data = await res.json();
        // Remove typing indicator
        typingEl.remove();

        if (data.reply) {
          addMessage(data.reply, "bot");
          scrollToBottom();
        } else {
          addMessage("Beklager, ingen svar mottatt.", "bot");
          scrollToBottom();
        }
      } catch (err) {
        typingEl.remove();
        addMessage("Noe gikk galt. PrÃ¸v igjen senere.", "bot");
        console.error(err);
        scrollToBottom();
      }
    });

    function addMessage(text, sender) {
      const msg = document.createElement("div");
      msg.className = `chat-message flex ${sender === "user" ? "justify-end" : "justify-start"} items-end`;
      msg.innerHTML = `
        <div class="max-w-xs ${
          sender === "user"
            ? "bg-white text-black"
            : "bg-gray-800 text-white"
        } p-3 rounded-xl">
          ${text}
        </div>`;
      chatMessages.appendChild(msg);
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  </script>
</body>
</html>
